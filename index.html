<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Asistencia</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f3f7fb;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background-color: #ffffff;
      border-radius: 16px;
      padding: 20px;
      width: 100%;
      max-width: 900px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    h2 {
      text-align: center;
      color: #2a5d8f;
      margin-bottom: 20px;
    }

    .form {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    input {
      flex: 1;
      padding: 14px;
      border: 1px solid #c7dff6;
      border-radius: 10px;
      font-size: 1.1em;
    }

    .btn-agregar {
      background-color: #2a7de1;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 14px 20px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.1em;
      transition: 0.3s;
    }
    .btn-agregar:hover { background-color: #1e66b3; }

    .paciente {
      background-color: #f0f6ff;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      position: relative;
      transition: background-color 0.3s;
    }

    .paciente.asistio { background-color: #e7f8e9; }
    .paciente.noasistio { background-color: #fbe7e7; }
    .paciente.cambio { background-color: #fff7e0; }

    .info {
      color: #2a5d8f;
      font-weight: bold;
      font-size: 1.2em;
      flex: 1;
    }

    .acciones {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .acciones button {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 1em;
      border: none;
      cursor: pointer;
    }

    .btn-asistencia { background-color: #2a7de1; color: white; }
    .btn-ver { background-color: #d0e2f7; color: #2a5d8f; }

    .btn-eliminar {
      position: absolute;
      top: 6px;
      right: 8px;
      background: transparent;
      color: #888;
      font-size: 1.2em;
      border: none;
      cursor: pointer;
    }
    .btn-eliminar:hover { color: #e74c3c; }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 20px;
      max-width: 520px;
      width: 90%;
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
      text-align: center;
      animation: fadeIn 0.3s ease;
    }
    .modal-content h3 { margin-bottom: 16px; color: #2a5d8f; }

    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .modal-buttons button {
      padding: 12px 18px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      font-weight: bold;
      color: white;
    }
    .btn-asistio { background: #28a745; }
    .btn-noasistio { background: #dc3545; }
    .btn-cambio { background: #ffc107; color: black; }
    .btn-cancelar { background: #6c757d; }
    .btn-modificar { background: #2a7de1; }

    /* Resumen */
    .resumen-lista {
      text-align: left;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
    }
    .resumen-item {
      background: #f9fbfd;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95em;
      color: #333;
      border: 1px solid #e0e6f0;
    }
    .resumen-item button {
      background: transparent;
      border: none;
      color: #dc3545;
      font-size: 1.1em;
      cursor: pointer;
    }
    .resumen-item button:hover { color: #a71d2a; }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Registro de Asistencia</h2>
    <div class="form">
      <input id="nombre" placeholder="Nombre del paciente" />
      <button id="guardar" class="btn-agregar">Agregar</button>
    </div>
    <div id="lista"></div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      deleteDoc,
      doc,
      query,
      where,
      getDocs,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDyFzxJFKPQt5Ytke6vP6o33mlOEK-iGd0",
      authDomain: "pacienteswebfinal.firebaseapp.com",
      projectId: "pacienteswebfinal",
      storageBucket: "pacienteswebfinal.appspot.com",
      messagingSenderId: "421058444223",
      appId: "1:421058444223:web:b84d7e0d9944a1b78e7f0a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const listaEl = document.getElementById("lista");
    const nombreEl = document.getElementById("nombre");
    const guardarBtn = document.getElementById("guardar");

    function showModal(contentHTML) {
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `<div class="modal-content">${contentHTML}</div>`;
      document.body.appendChild(modal);
      return modal;
    }

    function renderizar() {
      const q = collection(db, "pacientes");
      onSnapshot(q, snapshot => {
        listaEl.innerHTML = "";
        if (snapshot.empty) {
          listaEl.innerHTML = "<div>No hay pacientes guardados.</div>";
          return;
        }
        snapshot.forEach(docSnap => {
          const p = docSnap.data();
          const id = docSnap.id;

          const row = document.createElement("div");
          row.className = "paciente";

          const info = document.createElement("div");
          info.className = "info";
          info.textContent = p.nombre;

          const acciones = document.createElement("div");
          acciones.className = "acciones";

          const btnAsistencia = document.createElement("button");
          btnAsistencia.className = "btn-asistencia";
          btnAsistencia.textContent = "‚úì Asistencia";
          btnAsistencia.onclick = () => {
            const modal = showModal(`
              <h3>Marcar asistencia</h3>
              <div class="modal-buttons">
                <button class="btn-asistio">Asisti√≥</button>
                <button class="btn-noasistio">No asisti√≥</button>
                <button class="btn-cambio">Cambio de fecha</button>
                <button class="btn-cancelar">Cancelar</button>
              </div>
              <div style="margin-top:15px;">
                <input id="fechaManual" type="date" style="display:none;" />
                <button class="btn-modificar">Modificar fecha</button>
              </div>
            `);

            let fechaVisible = false;

            modal.querySelector(".btn-modificar").onclick = () => {
              const input = modal.querySelector("#fechaManual");
              fechaVisible = !fechaVisible;
              input.style.display = fechaVisible ? "inline-block" : "none";
            };

            function getFechaSeleccionada() {
              const inputFecha = modal.querySelector("#fechaManual").value;
              if (inputFecha) {
                const partes = inputFecha.split("-");
                return Timestamp.fromDate(new Date(partes[0], partes[1]-1, partes[2]));
              }
              return Timestamp.now();
            }

            modal.querySelector(".btn-asistio").onclick = async () => {
              await guardarAsistencia(id, p.nombre, "asisti√≥", getFechaSeleccionada());
              row.classList.add("asistio");
              modal.remove();
            };
            modal.querySelector(".btn-noasistio").onclick = async () => {
              await guardarAsistencia(id, p.nombre, "no asisti√≥", getFechaSeleccionada());
              row.classList.add("noasistio");
              modal.remove();
            };
            modal.querySelector(".btn-cambio").onclick = async () => {
              await guardarAsistencia(id, p.nombre, "cambio de fecha", getFechaSeleccionada());
              row.classList.add("cambio");
              modal.remove();
            };
            modal.querySelector(".btn-cancelar").onclick = () => modal.remove();
          };

          const btnVer = document.createElement("button");
          btnVer.className = "btn-ver";
          btnVer.textContent = "üîç Ver";
          btnVer.onclick = async () => {
            const inicioMes = new Date();
            inicioMes.setDate(1);
            inicioMes.setHours(0, 0, 0, 0);

            const q = query(collection(db, "asistencias"), where("pacienteId", "==", id));
            const snapshot = await getDocs(q);

            let total = 0;
            let itemsHTML = "";
            const clavesRegistradas = new Set();

            const diasSemana = ["domingo","lunes","martes","mi√©rcoles","jueves","viernes","s√°bado"];
            const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","setiembre","octubre","noviembre","diciembre"];

            // ordenar y filtrar duplicados
            const asistencias = snapshot.docs
              .map(d => ({ id: d.id, ...d.data(), fechaDate: d.data().fecha.toDate() }))
              .filter(d => d.fechaDate >= inicioMes)
              .sort((a,b) => a.fechaDate - b.fechaDate);

            for (const data of asistencias) {
              const fecha = data.fechaDate;
              const clave = `${fecha.toDateString()}-${data.estado}`;
              if (clavesRegistradas.has(clave)) continue;
              clavesRegistradas.add(clave);

              total++;
              const diaSemana = diasSemana[fecha.getDay()];
              const dia = fecha.getDate();
              const mes = meses[fecha.getMonth()];
              const anio = fecha.getFullYear();

              itemsHTML += `
                <div class="resumen-item">
                  <span>${diaSemana} ${dia} de ${mes} de ${anio} ‚Üí ${data.estado}</span>
                  <button data-id="${data.id}">‚ùå</button>
                </div>
              `;
            }

            const modal = showModal(`
              <h3>Resumen de ${p.nombre}</h3>
              <div class="resumen-lista">
                ${itemsHTML || "<em>No hay asistencias este mes</em>"}
              </div>
              <p style="font-size:1.3em; font-weight:bold; color:#2a7de1;">Total asistencias: ${total}</p>
              <div class="modal-buttons">
                <button class="btn-cancelar">Cerrar</button>
              </div>
            `);

            modal.querySelectorAll(".resumen-item button").forEach(btn => {
              btn.onclick = async () => {
                if (confirm("¬øEliminar esta asistencia?")) {
                  await deleteDoc(doc(db, "asistencias", btn.dataset.id));
                  modal.remove();
                }
              };
            });

            modal.querySelector(".btn-cancelar").onclick = () => modal.remove();
          };

          const btnEliminar = document.createElement("button");
          btnEliminar.className = "btn-eliminar";
          btnEliminar.textContent = "‚àí";
          btnEliminar.onclick = async () => {
            if (confirm("¬øEliminar paciente?")) {
              await deleteDoc(doc(db, "pacientes", id));
            }
          };

          acciones.appendChild(btnAsistencia);
          acciones.appendChild(btnVer);

          row.appendChild(info);
          row.appendChild(acciones);
          row.appendChild(btnEliminar);
          listaEl.appendChild(row);
        });
      });
    }

    async function guardarAsistencia(id, nombre, estado, fecha) {
      await addDoc(collection(db, "asistencias"), {
        pacienteId: id,
        nombre,
        fecha,
        estado
      });
    }

    async function agregarPaciente() {
      const nombre = nombreEl.value.trim();
      if (!nombre) { alert("Ingrese un nombre."); return; }

      const modal = showModal(`
        <h3>Datos de ${nombre}</h3>
        <input id="edad" placeholder="Edad (opcional)" type="number" min="0" />
        <input id="celular" placeholder="Celular (opcional)" />
        <div class="modal-buttons">
          <button class="btn-cancelar">Cancelar</button>
          <button class="btn-asistio">Guardar</button>
        </div>
      `);

      modal.querySelector(".btn-cancelar").onclick = () => modal.remove();
      modal.querySelector(".btn-asistio").onclick = async () => {
        const edad = modal.querySelector("#edad").value.trim();
        const celular = modal.querySelector("#celular").value.trim();
        await addDoc(collection(db, "pacientes"), { nombre, edad, celular });
        modal.remove();
        nombreEl.value = "";
      };
    }

    guardarBtn.addEventListener("click", agregarPaciente);
    renderizar();
  </script>
</body>
</html>
